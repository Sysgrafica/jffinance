<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - Finnairaceora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <header class="header">
        <nav class="nav container">
            <div class="nav-logo">
                <i class="fas fa-wallet"></i> Finnairaceora
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="bancos.html" class="nav-link"><i class="fas fa-university"></i> Bancos</a></li>
                <li><a href="cartoes.html" class="nav-link"><i class="fas fa-credit-card"></i> Cartões</a></li>
                <li><a href="gastos.html" class="nav-link"><i class="fas fa-money-bill-wave"></i> Gastos</a></li>
                <li><a href="rendas.html" class="nav-link"><i class="fas fa-hand-holding-usd"></i> Rendas</a></li>
                <li><a href="settings.html" class="nav-link active"><i class="fas fa-cog"></i> Configurações</a></li>
                <li id="userInfo">
                    <!-- O conteúdo será preenchido pelo script de autenticação -->
                </li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <h2>Configurações do Sistema</h2>
            </div>
            <div class="card-body">
                <!-- Configuração de Tema -->
                <div class="settings-item">
                    <div class="settings-label">
                        <i class="fas fa-palette"></i>
                        <span>Tema</span>
                    </div>
                    <div class="settings-control">
                        <select id="themeSelector" class="form-input">
                            <option value="light">Claro</option>
                            <option value="dark">Escuro</option>
                        </select>
                    </div>
                </div>

                <!-- Configuração de Notificações -->
                <div class="settings-item">
                    <div class="settings-label">
                        <i class="fas fa-bell"></i>
                        <span>Notificações</span>
                    </div>
                    <div class="settings-control">
                        <label class="switch">
                            <input type="checkbox" id="notificationsToggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <!-- Configuração de Moeda -->
                <div class="settings-item">
                    <div class="settings-label">
                        <i class="fas fa-money-bill-alt"></i>
                        <span>Moeda Principal</span>
                    </div>
                    <div class="settings-control">
                        <select id="currencySelector" class="form-input">
                            <option value="BRL">Real (BRL)</option>
                            <option value="USD">Dólar (USD)</option>
                            <option value="EUR">Euro (EUR)</option>
                        </select>
                    </div>
                </div>

                 <!-- Apagar Dados Locais -->
                 <div class="settings-item">
                    <div class="settings-label">
                        <i class="fas fa-trash-alt"></i>
                        <span>Apagar Dados</span>
                    </div>
                    <div class="settings-control">
                        <button id="clearDataButton" class="btn btn-perigo">
                            <i class="fas fa-exclamation-triangle"></i> Limpar Dados Locais
                        </button>
                    </div>
                </div>

            </div>
            <div class="card-footer">
                <button id="saveSettings" class="btn btn-primario">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>

        <!-- Seção de Gerenciamento de Metas -->
        <div class="card mt-2">
            <div class="card-header">
                <h2>Gerenciar Metas de Gastos</h2>
            </div>
            <div class="card-body" id="metasContainer">
                <!-- As metas serão carregadas aqui -->
            </div>
            <div class="card-footer">
                <button class="btn btn-secondary" onclick="adicionarMeta()">
                    <i class="fas fa-plus"></i> Nova Meta
                </button>
                <button class="btn btn-primary" onclick="salvarMetas()">
                    <i class="fas fa-save"></i> Salvar Metas
                </button>
            </div>
        </div>

        <!-- Seção de Gerenciamento de Metas de Renda -->
        <div class="card mt-2">
            <div class="card-header">
                <h2>Gerenciar Metas de Renda</h2>
            </div>
            <div class="card-body" id="metasRendaContainer">
                <!-- As metas de renda serão carregadas aqui -->
            </div>
            <div class="card-footer">
                <button class="btn btn-secondary" onclick="adicionarMetaRenda()">
                    <i class="fas fa-plus"></i> Nova Meta de Renda
                </button>
                <button class="btn btn-primary" onclick="salvarMetasRenda()">
                    <i class="fas fa-save"></i> Salvar Metas de Renda
                </button>
            </div>
        </div>

        <!-- Seção de Gerenciamento de Categorias -->
        <div class="card mt-2">
            <div class="card-header">
                <h2>Gerenciar Categorias</h2>
                <div>
                    <button class="btn btn-secondary" onclick="reinicializarCategorias()">
                        <i class="fas fa-sync"></i> Restaurar Padrões
                    </button>
                    <button class="btn btn-primary" onclick="abrirModalCategoria()">
                        <i class="fas fa-plus"></i> Nova Categoria
                    </button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="mudarTipo('gasto')">Categorias de Gastos</button>
                <button class="tab-btn" onclick="mudarTipo('renda')">Categorias de Rendas</button>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Ícone</th>
                            <th>Cor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCategorias"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de Categoria -->
    <div id="modalCategoria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTituloCategoria">Nova Categoria</h3>
                <button class="btn-close" onclick="fecharModalCategoria()">&times;</button>
            </div>
            <form id="formCategoria" onsubmit="salvarCategoria(event)">
                <input type="hidden" id="categoriaId">
                <input type="hidden" id="tipoCategoria" value="gasto">

                <div class="form-group">
                    <label for="nomeCategoria">Nome</label>
                    <input type="text" id="nomeCategoria" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="iconeCategoria">Ícone (classe Font Awesome)</label>
                    <div class="input-group">
                        <input type="text" id="iconeCategoria" class="form-input" value="fas fa-tag" required>
                        <span class="input-group-text">
                            <i id="previewIcone" class="fas fa-tag"></i>
                        </span>
                    </div>
                    <small>Ex: fas fa-tag, fas fa-home, fas fa-car</small>
                </div>

                <div class="form-group">
                    <label for="corCategoria">Cor</label>
                    <input type="color" id="corCategoria" class="form-input" value="#2ECC71" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalCategoria()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2024 Finnairaceora - Controle Financeiro</p>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Nossa inicialização do Firebase -->
    <script src="../assets/js/firebase-init.js"></script>
    
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/database.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/settings.js"></script>
    <script>
        // Lógica de Metas
        function carregarMetas() {
            const container = document.getElementById('metasContainer');
            const metas = JSON.parse(localStorage.getItem('metas_gastos')) || [
                { id: 1, nome: 'Gastos Pessoais', icone: 'fas fa-user', valor: 300.00 },
                { id: 2, nome: 'Gastos Casa', icone: 'fas fa-home', valor: 1500.00 }
            ];
            
            // Salva o padrão se não existir
            if (!localStorage.getItem('metas_gastos')) {
                localStorage.setItem('metas_gastos', JSON.stringify(metas));
            }

            container.innerHTML = '';
            metas.forEach(meta => {
                const metaEl = document.createElement('div');
                metaEl.className = 'settings-item';
                metaEl.dataset.metaId = meta.id;
                metaEl.innerHTML = `
                    <div class="settings-label">
                        <input type="text" class="form-input" value="${meta.icone}" placeholder="Ícone Font Awesome">
                        <input type="text" class="form-input" value="${meta.nome}" placeholder="Nome da Meta">
                    </div>
                    <div class="settings-control">
                        <input type="number" class="form-input" value="${meta.valor}" placeholder="Valor da Meta" step="0.01">
                        <button class="btn btn-danger btn-small" onclick="removerMeta(${meta.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(metaEl);
            });
        }

        function adicionarMeta() {
            const container = document.getElementById('metasContainer');
            const newId = Date.now(); // ID único simples
            const metaEl = document.createElement('div');
            metaEl.className = 'settings-item';
            metaEl.dataset.metaId = newId;
            metaEl.innerHTML = `
                <div class="settings-label">
                    <input type="text" class="form-input" placeholder="Ícone Font Awesome" value="fas fa-star">
                    <input type="text" class="form-input" placeholder="Nome da Meta">
                </div>
                <div class="settings-control">
                    <input type="number" class="form-input" placeholder="Valor da Meta" step="0.01">
                    <button class="btn btn-danger btn-small" onclick="removerMeta(${newId})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(metaEl);
        }

        function removerMeta(id) {
            if (confirm('Tem certeza que deseja remover esta meta?')) {
                document.querySelector(`[data-meta-id='${id}']`).remove();
                // A remoção do localStorage acontece ao salvar.
            }
        }

        function salvarMetas() {
            const container = document.getElementById('metasContainer');
            const metaElements = container.querySelectorAll('.settings-item');
            const novasMetas = [];
            metaElements.forEach(el => {
                const id = Number(el.dataset.metaId);
                const icone = el.querySelector('.settings-label input:first-child').value;
                const nome = el.querySelector('.settings-label input:last-child').value;
                const valor = parseFloat(el.querySelector('.settings-control input').value);

                if (nome && valor) {
                    novasMetas.push({ id, icone, nome, valor });
                }
            });

            localStorage.setItem('metas_gastos', JSON.stringify(novasMetas));
            alert('Metas salvas com sucesso!');
        }

        // Lógica de Metas de Renda
        function carregarMetasRenda() {
            const container = document.getElementById('metasRendaContainer');
            const metas = JSON.parse(localStorage.getItem('metas_renda')) || [
                { id: 1, nome: 'Renda Principal', icone: 'fas fa-briefcase', valor: 3000.00 },
                { id: 2, nome: 'Renda Extra', icone: 'fas fa-coins', valor: 1000.00 }
            ];
            // Salva o padrão se não existir
            if (!localStorage.getItem('metas_renda')) {
                localStorage.setItem('metas_renda', JSON.stringify(metas));
            }
            container.innerHTML = '';
            metas.forEach(meta => {
                const metaEl = document.createElement('div');
                metaEl.className = 'settings-item';
                metaEl.dataset.metaId = meta.id;
                metaEl.innerHTML = `
                    <div class="settings-label">
                        <input type="text" class="form-input" value="${meta.icone}" placeholder="Ícone Font Awesome">
                        <input type="text" class="form-input" value="${meta.nome}" placeholder="Nome da Meta de Renda">
                    </div>
                    <div class="settings-control">
                        <input type="number" class="form-input" value="${meta.valor}" placeholder="Valor da Meta" step="0.01">
                        <button class="btn btn-danger btn-small" onclick="removerMetaRenda(${meta.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(metaEl);
            });
        }

        function adicionarMetaRenda() {
            const container = document.getElementById('metasRendaContainer');
            const newId = Date.now();
            const metaEl = document.createElement('div');
            metaEl.className = 'settings-item';
            metaEl.dataset.metaId = newId;
            metaEl.innerHTML = `
                <div class="settings-label">
                    <input type="text" class="form-input" placeholder="Ícone Font Awesome" value="fas fa-star">
                    <input type="text" class="form-input" placeholder="Nome da Meta de Renda">
                </div>
                <div class="settings-control">
                    <input type="number" class="form-input" placeholder="Valor da Meta" step="0.01">
                    <button class="btn btn-danger btn-small" onclick="removerMetaRenda(${newId})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(metaEl);
        }

        function removerMetaRenda(id) {
            if (confirm('Tem certeza que deseja remover esta meta de renda?')) {
                document.querySelector(`#metasRendaContainer [data-meta-id='${id}']`).remove();
            }
        }

        function salvarMetasRenda() {
            const container = document.getElementById('metasRendaContainer');
            const metaElements = container.querySelectorAll('.settings-item');
            const novasMetas = [];
            metaElements.forEach(el => {
                const id = Number(el.dataset.metaId);
                const icone = el.querySelector('.settings-label input:first-child').value;
                const nome = el.querySelector('.settings-label input:last-child').value;
                const valor = parseFloat(el.querySelector('.settings-control input').value);
                if (nome && valor) {
                    novasMetas.push({ id, icone, nome, valor });
                }
            });
            localStorage.setItem('metas_renda', JSON.stringify(novasMetas));
            alert('Metas de renda salvas com sucesso!');
        }

        // Lógica de Categorias
        let tipoAtual = 'gasto';

        function setupCategoryListeners() {
            // Garante que as tabelas de categorias existam
            if (!localStorage.getItem('categorias_gastos') || !localStorage.getItem('categorias_rendas')) {
                // Verificar se a função reset existe antes de chamá-la
                if (typeof db.reset === 'function') {
                    db.reset();
                } else {
                    console.warn("Função db.reset não encontrada. Inicializando categorias padrão manualmente.");
                    // Categorias padrão de gastos
                    const categoriasGastos = [
                        { id: 1, nome: 'Alimentação', icone: 'fas fa-utensils', cor: '#E74C3C' },
                        { id: 2, nome: 'Moradia', icone: 'fas fa-home', cor: '#3498DB' },
                        { id: 3, nome: 'Transporte', icone: 'fas fa-car', cor: '#2ECC71' },
                        { id: 4, nome: 'Saúde', icone: 'fas fa-heartbeat', cor: '#9B59B6' },
                        { id: 5, nome: 'Educação', icone: 'fas fa-graduation-cap', cor: '#F1C40F' },
                        { id: 6, nome: 'Lazer', icone: 'fas fa-glass-cheers', cor: '#E67E22' },
                        { id: 7, nome: 'Pessoal', icone: 'fas fa-user', cor: '#1ABC9C' },
                        { id: 8, nome: 'Outros', icone: 'fas fa-ellipsis-h', cor: '#95A5A6' }
                    ];
                    
                    // Categorias padrão de rendas
                    const categoriasRendas = [
                        { id: 1, nome: 'Salário', icone: 'fas fa-money-bill-wave', cor: '#2ECC71' },
                        { id: 2, nome: 'Freelance', icone: 'fas fa-laptop', cor: '#3498DB' },
                        { id: 3, nome: 'Investimentos', icone: 'fas fa-chart-line', cor: '#F1C40F' },
                        { id: 4, nome: 'Aluguel', icone: 'fas fa-building', cor: '#9B59B6' },
                        { id: 5, nome: 'Outros', icone: 'fas fa-ellipsis-h', cor: '#95A5A6' }
                    ];
                    
                    localStorage.setItem('categorias_gastos', JSON.stringify(categoriasGastos));
                    localStorage.setItem('categorias_rendas', JSON.stringify(categoriasRendas));
                }
            }

            carregarCategorias();

            // Preview do ícone ao digitar
            document.getElementById('iconeCategoria').addEventListener('input', (e) => {
                const icone = document.getElementById('previewIcone');
                icone.className = e.target.value;
            });
        }

        // Reinicializa as categorias com os valores padrão
        function reinicializarCategorias() {
            if (confirm('Tem certeza que deseja restaurar as categorias padrão? Todas as categorias personalizadas serão perdidas.')) {
                // Verificar se a função reset existe antes de chamá-la
                if (typeof db.reset === 'function') {
                    db.reset();
                } else {
                    console.warn("Função db.reset não encontrada. Inicializando categorias padrão manualmente.");
                    // Categorias padrão de gastos
                    const categoriasGastos = [
                        { id: 1, nome: 'Alimentação', icone: 'fas fa-utensils', cor: '#E74C3C' },
                        { id: 2, nome: 'Moradia', icone: 'fas fa-home', cor: '#3498DB' },
                        { id: 3, nome: 'Transporte', icone: 'fas fa-car', cor: '#2ECC71' },
                        { id: 4, nome: 'Saúde', icone: 'fas fa-heartbeat', cor: '#9B59B6' },
                        { id: 5, nome: 'Educação', icone: 'fas fa-graduation-cap', cor: '#F1C40F' },
                        { id: 6, nome: 'Lazer', icone: 'fas fa-glass-cheers', cor: '#E67E22' },
                        { id: 7, nome: 'Pessoal', icone: 'fas fa-user', cor: '#1ABC9C' },
                        { id: 8, nome: 'Outros', icone: 'fas fa-ellipsis-h', cor: '#95A5A6' }
                    ];
                    
                    // Categorias padrão de rendas
                    const categoriasRendas = [
                        { id: 1, nome: 'Salário', icone: 'fas fa-money-bill-wave', cor: '#2ECC71' },
                        { id: 2, nome: 'Freelance', icone: 'fas fa-laptop', cor: '#3498DB' },
                        { id: 3, nome: 'Investimentos', icone: 'fas fa-chart-line', cor: '#F1C40F' },
                        { id: 4, nome: 'Aluguel', icone: 'fas fa-building', cor: '#9B59B6' },
                        { id: 5, nome: 'Outros', icone: 'fas fa-ellipsis-h', cor: '#95A5A6' }
                    ];
                    
                    localStorage.setItem('categorias_gastos', JSON.stringify(categoriasGastos));
                    localStorage.setItem('categorias_rendas', JSON.stringify(categoriasRendas));
                }
                carregarCategorias();
                Utils.mostrarMensagem('Categorias restauradas com sucesso!', 'sucesso');
            }
        }

        // Muda o tipo de categoria (gasto/renda)
        function mudarTipo(tipo) {
            tipoAtual = tipo;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            carregarCategorias();
        }

        // Carrega as categorias na tabela
        function carregarCategorias() {
            const entidade = tipoAtual === 'gasto' ? 'categorias_gastos' : 'categorias_rendas';
            
            // Tentar obter categorias do localStorage primeiro
            let categorias = [];
            try {
                const categoriasLocalStorage = localStorage.getItem(entidade);
                if (categoriasLocalStorage) {
                    categorias = JSON.parse(categoriasLocalStorage);
                }
            } catch (error) {
                console.error("Erro ao obter categorias do localStorage:", error);
            }
            
            // Se não houver categorias no localStorage, tentar do banco de dados
            if (!categorias || categorias.length === 0) {
                try {
                    const categoriasDB = db.getAll(entidade);
                    // Verificar se o resultado é um array
                    if (Array.isArray(categoriasDB)) {
                        categorias = categoriasDB;
                    } else if (categoriasDB && typeof categoriasDB.then === 'function') {
                        // Se for uma Promise, estamos usando Firestore assíncrono
                        categoriasDB.then(result => {
                            if (Array.isArray(result) && result.length > 0) {
                                renderizarCategorias(result);
                            } else {
                                renderizarCategoriasVazio();
                            }
                        }).catch(error => {
                            console.error("Erro ao obter categorias do Firestore:", error);
                            renderizarCategoriasVazio();
                        });
                        return; // Retorna aqui pois o processamento continuará na Promise
                    }
                } catch (error) {
                    console.error("Erro ao obter categorias do banco de dados:", error);
                }
            }
            
            // Renderizar as categorias obtidas
            if (Array.isArray(categorias) && categorias.length > 0) {
                renderizarCategorias(categorias);
            } else {
                renderizarCategoriasVazio();
            }
        }
        
        // Função auxiliar para renderizar categorias
        function renderizarCategorias(categorias) {
            const tbody = document.getElementById('tabelaCategorias');
            tbody.innerHTML = '';
            
            categorias.forEach(categoria => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${categoria.nome}</td>
                    <td><i class="${categoria.icone}" style="color: ${categoria.cor}"></i> ${categoria.icone}</td>
                    <td>
                        <span class="cor-preview" style="background-color: ${categoria.cor}"></span>
                        ${categoria.cor}
                    </td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="editarCategoria(${categoria.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="excluirCategoria(${categoria.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função auxiliar para renderizar mensagem de nenhuma categoria
        function renderizarCategoriasVazio() {
            const tbody = document.getElementById('tabelaCategorias');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">Nenhuma categoria cadastrada.</td>
                </tr>
            `;
        }

        // Abre o modal de categoria
        function abrirModalCategoria(categoriaId = null) {
            const modal = document.getElementById('modalCategoria');
            const titulo = document.getElementById('modalTituloCategoria');
            const form = document.getElementById('formCategoria');
            
            const entidade = tipoAtual === 'gasto' ? 'categorias_gastos' : 'categorias_rendas';
            
            // Se não temos um ID para editar, apenas abrir o modal para nova categoria
            if (!categoriaId) {
                titulo.textContent = 'Nova Categoria';
                form.reset();
                document.getElementById('categoriaId').value = '';
                document.getElementById('tipoCategoria').value = tipoAtual;
                document.getElementById('previewIcone').className = 'fas fa-tag';
                
                modal.classList.add('active');
                modal.style.display = 'flex';
                return;
            }
            
            // Tentar obter categorias do localStorage primeiro
            try {
                const categoriasLocalStorage = localStorage.getItem(entidade);
                if (categoriasLocalStorage) {
                    const categorias = JSON.parse(categoriasLocalStorage);
                    const categoria = categorias.find(c => c.id === Number(categoriaId));
                    
                    if (categoria) {
                        preencherFormularioCategoria(categoria);
                        modal.classList.add('active');
                        modal.style.display = 'flex';
                        return;
                    }
                }
            } catch (error) {
                console.error("Erro ao obter categorias do localStorage:", error);
            }
            
            // Se não encontrou no localStorage, tentar do banco de dados
            try {
                const categoriasPromise = db.getAll(entidade);
                
                if (categoriasPromise && typeof categoriasPromise.then === 'function') {
                    // É uma Promise
                    categoriasPromise.then(categorias => {
                        if (Array.isArray(categorias)) {
                            const categoria = categorias.find(c => c.id === Number(categoriaId));
                            if (categoria) {
                                preencherFormularioCategoria(categoria);
                            } else {
                                prepararNovaCategoria();
                            }
                        } else {
                            prepararNovaCategoria();
                        }
                        modal.classList.add('active');
                        modal.style.display = 'flex';
                    }).catch(error => {
                        console.error("Erro ao obter categorias do Firestore:", error);
                        prepararNovaCategoria();
                        modal.classList.add('active');
                        modal.style.display = 'flex';
                    });
                } else {
                    // Não é uma Promise, é um array direto
                    const categorias = categoriasPromise;
                    if (Array.isArray(categorias)) {
                        const categoria = categorias.find(c => c.id === Number(categoriaId));
                        if (categoria) {
                            preencherFormularioCategoria(categoria);
                        } else {
                            prepararNovaCategoria();
                        }
                    } else {
                        prepararNovaCategoria();
                    }
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                }
            } catch (error) {
                console.error("Erro ao obter categorias do banco de dados:", error);
                prepararNovaCategoria();
                modal.classList.add('active');
                modal.style.display = 'flex';
            }
                }
        
        // Função auxiliar para preencher o formulário de categoria
        function preencherFormularioCategoria(categoria) {
            const titulo = document.getElementById('modalTituloCategoria');
            titulo.textContent = 'Editar Categoria';
            document.getElementById('categoriaId').value = categoria.id;
            document.getElementById('nomeCategoria').value = categoria.nome;
            document.getElementById('iconeCategoria').value = categoria.icone;
            document.getElementById('corCategoria').value = categoria.cor;
            document.getElementById('previewIcone').className = categoria.icone;
        }
        
        // Função auxiliar para preparar o formulário para nova categoria
        function prepararNovaCategoria() {
            const titulo = document.getElementById('modalTituloCategoria');
            const form = document.getElementById('formCategoria');
            titulo.textContent = 'Nova Categoria';
            form.reset();
            document.getElementById('categoriaId').value = '';
            document.getElementById('tipoCategoria').value = tipoAtual;
            document.getElementById('previewIcone').className = 'fas fa-tag';
        }

        // Fecha o modal de categoria
        function fecharModalCategoria() {
            const modal = document.getElementById('modalCategoria');
            modal.classList.remove('active');
            modal.style.display = 'none';
        }

        // Salva uma categoria
        function salvarCategoria(event) {
            event.preventDefault();
            
            const entidade = tipoAtual === 'gasto' ? 'categorias_gastos' : 'categorias_rendas';
            const categoriaId = document.getElementById('categoriaId').value;
            
            const categoriaData = {
                nome: document.getElementById('nomeCategoria').value,
                icone: document.getElementById('iconeCategoria').value,
                cor: document.getElementById('corCategoria').value
            };
            
            // Mostrar indicador de carregamento
            const btnSalvar = event.submitter;
            const textoOriginal = btnSalvar.innerHTML;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btnSalvar.disabled = true;
            
            let operacaoPromise;
            
            if (categoriaId) {
                operacaoPromise = db.update(entidade, Number(categoriaId), categoriaData);
            } else {
                operacaoPromise = db.insert(entidade, categoriaData);
            }
            
            // Verificar se é uma Promise
            if (operacaoPromise && typeof operacaoPromise.then === 'function') {
                // É uma Promise
                operacaoPromise.then(resultado => {
                    if (resultado) {
                        // Atualizar categorias no localStorage também
                        atualizarCategoriasLocalStorage(entidade, resultado);
                        carregarCategorias();
                        fecharModalCategoria();
                        Utils.mostrarMensagem('Categoria salva com sucesso!', 'sucesso');
                    } else {
                        Utils.mostrarMensagem('Erro ao salvar categoria.', 'erro');
                        // Restaurar botão
                        btnSalvar.innerHTML = textoOriginal;
                        btnSalvar.disabled = false;
                    }
                }).catch(error => {
                    console.error("Erro ao salvar categoria:", error);
                    Utils.mostrarMensagem('Erro ao salvar categoria.', 'erro');
                    // Restaurar botão
                    btnSalvar.innerHTML = textoOriginal;
                    btnSalvar.disabled = false;
                });
            } else {
                // Não é uma Promise, é um resultado direto
                if (operacaoPromise) {
                    // Atualizar categorias no localStorage também
                    atualizarCategoriasLocalStorage(entidade, operacaoPromise);
                    carregarCategorias();
                    fecharModalCategoria();
                    Utils.mostrarMensagem('Categoria salva com sucesso!', 'sucesso');
                } else {
                    Utils.mostrarMensagem('Erro ao salvar categoria.', 'erro');
                    // Restaurar botão
                    btnSalvar.innerHTML = textoOriginal;
                    btnSalvar.disabled = false;
                }
            }
        }
        
        // Função auxiliar para atualizar categorias no localStorage após salvar
        function atualizarCategoriasLocalStorage(entidade, novaCategoria) {
            try {
                const categoriasLocalStorage = localStorage.getItem(entidade);
                let categorias = [];
                
                if (categoriasLocalStorage) {
                    categorias = JSON.parse(categoriasLocalStorage);
                }
                
                // Verificar se já existe uma categoria com este ID
                const index = categorias.findIndex(c => c.id === novaCategoria.id);
                
                if (index !== -1) {
                    // Atualizar categoria existente
                    categorias[index] = novaCategoria;
                } else {
                    // Adicionar nova categoria
                    categorias.push(novaCategoria);
                }
                
                localStorage.setItem(entidade, JSON.stringify(categorias));
            } catch (error) {
                console.error("Erro ao atualizar categorias no localStorage:", error);
            }
        }

        // Edita uma categoria
        function editarCategoria(id) {
            abrirModalCategoria(id);
        }

        // Exclui uma categoria
        function excluirCategoria(id) {
            const entidade = tipoAtual === 'gasto' ? 'categorias_gastos' : 'categorias_rendas';
            const entidadeRelacionada = tipoAtual === 'gasto' ? 'gastos' : 'rendas';
            
            // Verificar se a categoria está sendo usada antes de excluir
            verificarCategoriaEmUso(entidadeRelacionada, id).then(emUso => {
                if (emUso) {
                    Utils.mostrarMensagem('Esta categoria não pode ser excluída pois está sendo usada.', 'erro');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                    // Excluir a categoria
                    const deletePromise = db.delete(entidade, Number(id));
                    
                    if (deletePromise && typeof deletePromise.then === 'function') {
                        // É uma Promise
                        deletePromise.then(success => {
                            if (success) {
                                // Atualizar categorias no localStorage também
                                atualizarCategoriaLocalStorage(entidade, id);
                                carregarCategorias();
                                Utils.mostrarMensagem('Categoria excluída com sucesso!', 'sucesso');
                            } else {
                                Utils.mostrarMensagem('Erro ao excluir categoria.', 'erro');
                            }
                        }).catch(error => {
                            console.error("Erro ao excluir categoria:", error);
                            Utils.mostrarMensagem('Erro ao excluir categoria.', 'erro');
                        });
                    } else {
                        // Não é uma Promise, é um resultado direto
                        if (deletePromise) {
                            // Atualizar categorias no localStorage também
                            atualizarCategoriaLocalStorage(entidade, id);
                            carregarCategorias();
                            Utils.mostrarMensagem('Categoria excluída com sucesso!', 'sucesso');
                        } else {
                            Utils.mostrarMensagem('Erro ao excluir categoria.', 'erro');
                        }
                    }
                }
            }).catch(error => {
                console.error("Erro ao verificar se categoria está em uso:", error);
                Utils.mostrarMensagem('Erro ao verificar se a categoria está em uso.', 'erro');
            });
        }
        
        // Função auxiliar para verificar se uma categoria está em uso
        async function verificarCategoriaEmUso(entidadeRelacionada, categoriaId) {
            try {
                // Tentar obter itens fixos
                const itemsFixosPromise = db.getAll(entidadeRelacionada + '_fixos');
                let itemsFixos = [];
                
                if (itemsFixosPromise && typeof itemsFixosPromise.then === 'function') {
                    // É uma Promise
                    itemsFixos = await itemsFixosPromise;
                } else {
                    // Não é uma Promise, é um array direto
                    itemsFixos = itemsFixosPromise || [];
                }
                
                // Tentar obter itens variáveis
                const itemsVariaveisPromise = db.getAll(entidadeRelacionada + '_variaveis');
                let itemsVariaveis = [];
                
                if (itemsVariaveisPromise && typeof itemsVariaveisPromise.then === 'function') {
                    // É uma Promise
                    itemsVariaveis = await itemsVariaveisPromise;
                } else {
                    // Não é uma Promise, é um array direto
                    itemsVariaveis = itemsVariaveisPromise || [];
                }
                
                // Garantir que são arrays
                const fixosArray = Array.isArray(itemsFixos) ? itemsFixos : [];
                const variaveisArray = Array.isArray(itemsVariaveis) ? itemsVariaveis : [];
                
                // Verificar se a categoria está em uso
                return [...fixosArray, ...variaveisArray].some(item => item && item.categoriaId === categoriaId);
            } catch (error) {
                console.error("Erro ao verificar se categoria está em uso:", error);
                return false; // Em caso de erro, permitir a exclusão
            }
        }
        
        // Função auxiliar para atualizar categorias no localStorage após exclusão
        function atualizarCategoriaLocalStorage(entidade, id) {
            try {
                const categoriasLocalStorage = localStorage.getItem(entidade);
                if (categoriasLocalStorage) {
                    const categorias = JSON.parse(categoriasLocalStorage);
                    const categoriasAtualizadas = categorias.filter(c => c.id !== Number(id));
                    localStorage.setItem(entidade, JSON.stringify(categoriasAtualizadas));
                }
            } catch (error) {
                console.error("Erro ao atualizar categorias no localStorage:", error);
            }
        }

        // Adiciona o listener quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            setupCategoryListeners();
            carregarMetas();
            carregarMetasRenda();
        });
    </script>
</body>

</html> 